---
title: "Efficacy of transdiagnostic cognitive-behavioral therapy for assertiveness: a randomized controlled trial of Respect Squared"
author: "Tobias Hagberg"
date: "220103"
lang: en-US
bibliography: ["packages.bib", "KSH.bib", "DBT.bib"]
link-citations: yes
output:
  beamer_presentation: 
    colortheme: seahorse
    keep_tex: yes
header-includes:
  - \usepackage[default]{sourcesanspro}
  - \usepackage[T1]{fontenc}
  - \usepackage{setspace}
  - \setstretch{1.2}
  - \widowpenalties 1 150
---

```{r setup, include=F}

# https://www.lcampanelli.org/mixed-effects-modeling-lme4/
# https://fukamilab.github.io/BIO202/04-A-mixed-models.html
# https://jtools.jacob-long.com/index.html
# https://arxiv.org/abs/1308.5499
# https://easystats.github.io/performance/
# http://glmm.wikidot.com/pkg-comparison
# http://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#should-i-treat-factor-xxx-as-fixed-or-random

#performance::model_performance(m3)
#performance::compare_performance(m1, m2, m3, m4, rank = TRUE)
#performance::plot(compare_performance(m1, m2, m4, rank = TRUE))

packages <-
  c(
    "lmerTest",
    "broom.mixed",
    "readxl",
    "writexl",
    "tidyr",
    "jtools",
    "interactions",
    "lattice",
    "modelr",
    "ggeffects",
    "emmeans",
    "patchwork",
    "outliers",
    "performance",
    "gridExtra",
    "broom.mixed",
    "sjPlot"
  )
if (!require("install.load")) install.packages("install.load")
library(install.load)
install_load(packages)

knitr::opts_chunk$set(
  warning = F,
  message = F,
  echo = F,
  collapse = T,
  fig.retina = 4,
  dpi = 300,
  out.width = "100%",
  fig.width = 7.5,
  fig.asp = 0.618
)

xg1 = "selfhelp"
xg2 = "support"
xg3 = "waitlist"
xG1 = "Selfhelp"
xG2 = "Support"
xG3 = "Waitlist"

xpre = "pre measurement"
xdur = "during measurement"
xpost = "post measurement"
xfu = "follow-up measurement"
xPre = "Pre measurement"
xDur = "During measurement"
xPost = "Post measurement"
xFu = "Follow-up measurement"

xt1 = "pre"
xt2 = "during"
xt3 = "post"
xt4 = "followup"
xT1 = "Pre"
xT2 = "During"
xT3 = "Post"
xT4 = "Followup"

```

# Background

## What is 'assertiveness'?

'Assertive self-expression' can be hard to delineate from 'social skills' in general [@LINEHAN1979], but a common definition is *direct, firm, positive [...] action [enabling] us to act in our own best interests, to stand up for ourselves without undue anxiety, to **exercise personal rights without denying the rights of others**, and to express our feelings and needs [...] honestly and comfortably* [@alberti1974your]. Examples include:

- Politely saying 'no' to a boss requesting undue overtime
- Actively participating in social activities
- Accepting/acknowledging a compliment without deflecting
- Verbalizing feelings in personal relationships without acting out

<!-- https://books.google.se/books?id=iPAhDgAAQBAJ&pg=PT85&hl=sv&source=gbs_selected_pages&cad=2#v=onepage&q&f=false -->

## Brief history of assertiveness training I

Assertiveness training goes back to the very first behavioral therapies [@salter1949conditioned; @Wolpe1966]. In the 1970's, the concept was popularized in self-help books such as @alberti1974your, @smith1975say, and @fensterheim1975don. Research in assertiveness training peaked in the 1980's [@Speed2018a]. The @LINEHAN1979 manual was extended to Dialectical Behavior Therapy (DBT), of which assertiveness training remain an integral part [@linehan1993skills]. 

## Brief history of assertiveness training II

Although the behavioral techniques of the 1st wave of therapy were supplemented by cognitive restructuring techniques [@beck1979cognitive] in the following decades, behavioral techniques such as modeling and behavior rehearsal have remained active parts of treatments for psychological syndromes such as anxiety disorders (such as social anxiety disorder) and depression.

## Clinical relevance

Low degrees of assertive self-expression is associated with both syndromal and non-syndromal suffering [@Speed2018a]:

:::: {.columns}
::: {.column width="45%"}
### @american1980diagnostic

- Generalized anxiety
- Social phobia
- Depression
- Borderline personality
- Schizophrenia
- ...
:::
::: {.column width="45%"}
### Non-syndromal

- Emotional dysregulation
- Strained relationships
- Work related stress
- Low self-esteem
- ...
:::
::::

## Prior research findings

### Assertiveness training

TBW

### Internet-delivered vs. in-person CBT

TBW

### Self-help vs. therapist support

TBW

### Transdiagnostic vs. specialized treatments

TBW

# Respect^2^

## Aim of Respect^2^ study

This study aims to investigate the efficacy of an 8-week cognitive-behavioral therapy (CBT) program targeting assertiveness.

## Respect^2^ treatment program

The program extends *Assert Yourself* [@michel2008], published by Centre for Clinical Interventions (CCI), Government of Western Australia in Australia. Respect^2^ is delivered via internet (I-CBT), with or without e-mail support from a therapist, and combines theories from 1st, 2nd and 3rd wave behavioral therapies to help participants select assertive behaviors in anxiety-provoking situations. 

## Primary research questions

- What is the effect on both adaptive and aggressive assertiveness of participation in Respect^2^ `r xG1` and `r xG2` treatment arms, compared to a `r xG3` condition?

- Is there a difference in efficacy betweeen  the `r xG1` and `r xG2` conditions?

## Secondary research question

- What is the effect on common measures for generalized anxiety, social anxiety, depression and overall well-being of participation in Respect^2^ `r xG1` and `r xG2` treatment arms, compared to a `r xG3` condition?

```{r prepare.data, echo = F, eval = F}

## Export settings

# - 2020-01-27 "Respekt i kvadrat - förmätning" PRE Groups 1+2+3
# - 2020-03-09 "Respekt i kvadrat - mittmätning utan Corona" DUR Groups 1+2+3
# - 2020-04-06 "Respekt i kvadrat - eftermätning" POST Groups 1+2
# - 2020-04-06 "Respekt i kvadrat - eftermätning väntelista" POST Group 3
# - 2021-04-21 "Respekt i kvadrat - 1-årsuppföljning" FU Groups 1+2

# Export settings recorded in "Screenshot 2021-12-12 at 11-29-37 Exportera.png"

raw_excel = "Respekt_surveys_211213_101425.xlsx"
r2fu.raw.data <- read_excel(raw_excel)

# Remove cases that meet exclusion criteria but were erroneously included in the study
r2fu.raw.data <- r2fu.raw.data[-c(13,48,52,97,158),]

# Missing data as NA values
r2fu.raw.data[r2fu.raw.data == "[missing data]" ] <- NA

# As dataframe
r2fu.raw.data <- as.data.frame(r2fu.raw.data)

# Unite POST measurements for Groups 1 + 2 with those for Group 3
cols.count <- 21
g3key <- which(!is.na(r2fu.raw.data[3 * cols.count + 8]))
r2fu.raw.data[g3key, c(1:cols.count) + 2 * cols.count] <-
  r2fu.raw.data[g3key, c(1:cols.count) + 3 * cols.count] # 2do: check if this is correct

# Create vector with group designations
r2fu.groups <-
  factor(ifelse(
    grepl("Grupp 1", r2fu.raw.data[,3]),
    1,
    ifelse(
      grepl("Grupp 2", r2fu.raw.data[,3]),
      2,
      ifelse(grepl("Grupp 3", r2fu.raw.data[,3]), 3, NA)
    )
  ),
  levels = c(3,1,2),
  labels = c(xg3,xg1,xg2))

# Only keep relevant columns
r2fu.raw.data <-
  r2fu.raw.data[, c(
    c(9:cols.count) + 0 * cols.count,
    c(9:cols.count) + 1 * cols.count,
    c(9:cols.count) + 2 * cols.count,
    c(9:cols.count) + 4 * cols.count
  )]

# Set colnames
timepoint.names <- c(1,2,3,4)
scale.names <- c(
  "rathus",
  "aaas_ag",
  "aaas_ad",
  "lsas_anx",
  "lsas_avo",
  "lsas_int",
  "lsas_per",
  "lsas_sum",
  "gad_sum",
  "phq_sum",
  "phq_sui",
  "phq_q10",
  "well"
)
colnames(r2fu.raw.data) <- paste(scale.names,rep(timepoint.names,each=length(scale.names)),sep=".")

# Add anonymous subject IDs
r2fu.raw.data$subject <- factor(c(1:length(r2fu.raw.data[,1]))) 

# Add in group designations
r2fu.raw.data$group <- r2fu.groups 

# Make sure numericals are numeric
r2fu.raw.data[, c(1:52)] <-
  sapply(r2fu.raw.data[, c(1:52)], as.numeric)

# Save anonymised data in wide format
saveRDS(r2fu.raw.data,file="r2fu.raw.data.RDS")

# Pivot to long format
r2fu.long.data <- r2fu.raw.data %>%
  pivot_longer(c(1:52),
               names_to = c(".value", "time"),
               names_pattern = "(.*).(\\d+)") %>% as.data.frame()
r2fu.long.data$time <- as.factor(r2fu.long.data$time)
saveRDS(r2fu.long.data,file="r2fu.long.data.RDS")
write_xlsx(r2fu.long.data, "r2fu.long.data.xlsx")

# Pivot back to wide format (should be equivalent to raw data)
r2fu.wide.data <- r2fu.long.data %>%
  pivot_wider(names_from = time,
              names_sep = ".",
              values_from = scale.names) %>% as.data.frame()
saveRDS(r2fu.wide.data,file="r2fu.wide.data.RDS")
write_xlsx(r2fu.wide.data, "r2fu.wide.data.xlsx")

```

```{r import.data}

r2fu.wide.data <- readRDS("r2fu.wide.data.RDS")
r2fu.long.data <- readRDS("r2fu.long.data.RDS")

# Add labels to time factor
r2fu.long.data$time <- factor(r2fu.long.data$time, labels = c(xt1,xt2,xt3,xt4))

# Add variable to discern between participants included/not included in fu 
#r2fu.long.data$studylength <- ifelse(r2fu.long.data$group == "waitlist", "no-fu", "fu")

# Subsetting keys
wg1 <- grepl(xg1, r2fu.wide.data$group)
wg2 <- grepl(xg2, r2fu.wide.data$group)
wg3 <- grepl(xg3, r2fu.wide.data$group)

# Subsetting keys 
lg1 <- grepl(xg1, r2fu.long.data$group)
lng1 <- !grepl(xg1, r2fu.long.data$group)
lg2 <- grepl(xg2, r2fu.long.data$group)
lng2 <- !grepl(xg2, r2fu.long.data$group)
lg3 <- grepl(xg3, r2fu.long.data$group)
lng3 <- !grepl(xg3, r2fu.long.data$group)
lt1 <- grepl(xt1, r2fu.long.data$time)
lt2 <- grepl(xt2, r2fu.long.data$time)
lt3 <- grepl(xt3, r2fu.long.data$time)
lt4 <- grepl(xt4, r2fu.long.data$time)
lnt4 <-!grepl(xt4, r2fu.long.data$time)
lg1t1 <- r2fu.long.data$group == xg1 & r2fu.long.data$time == xt1
lg1t2 <- r2fu.long.data$group == xg1 & r2fu.long.data$time == xt2
lg1t3 <- r2fu.long.data$group == xg1 & r2fu.long.data$time == xt3
lg2t1 <- r2fu.long.data$group == xg2 & r2fu.long.data$time == xt1
lg2t2 <- r2fu.long.data$group == xg2 & r2fu.long.data$time == xt2
lg2t3 <- r2fu.long.data$group == xg2 & r2fu.long.data$time == xt3
lg3t1 <- r2fu.long.data$group == xg3 & r2fu.long.data$time == xt1
lg3t2 <- r2fu.long.data$group == xg3 & r2fu.long.data$time == xt2
lg3t3 <- r2fu.long.data$group == xg3 & r2fu.long.data$time == xt3
ll1 = length(r2fu.long.data[lg1t1,1])
ll2 = length(r2fu.long.data[lg2t1,1])
ll3 = length(r2fu.long.data[lg3t1,1])

```

# Method

## Design

Respect^2^ is designed to fulfill the requirements for randomized controlled trials set out in @Chambless2001. The sample size for the three conditions (treatment arms `r xG1` and `r xG2`, and  control condition `r xG3`) were determined to 70 individuals each, based on an estimated effect size in agreement with the literature for CBT and I-CBT, $ES$ = 0.8, using $\alpha$ = 0.05.

## Conditions

### `r xG1`

TBW

### `r xG2`

TBW

### `r xG3`

TBW

## Recruitment

Study participants were recruited on social media between January 28 and February 5, 2020. During sign-up, all participants were presented with an informed consent form as well as practical information about what participation in the study would entail, before progressing to pre-measurement and collection of sociodemographic data.

## Inclusion/exclusion criteria used during screening

### Inclusion

- Swedish citizen
- Fluent in the Swedish language
- 18 years or older
- Internet access

### Exclusion

- Indication for depression (PHQ-9 result 15 or higher)
- Recent (previous 3 months) changes in psychotropic medication
- Concurrent psychological treatment
- Explicitly stated lack of motivation and/or time to participate

## Participants

\small

Out of 657 persons, 464 completed the sceening process, during which 126 were excluded for not meeting criteria for participation. A total of 338 persons were invited to the study, of which 253 accepted the invitation. Through randomization by a third party, 43 of these persons were excluded from the analysis (although not from participation in the treatment program) in order to reach the target sample size of $n$ = 210, which were further randomized into the three conditions by a third party. Another 5 persons ($n$ = 3 from `r xG1` and $n$ = 2 from `r xG3`) were excluded from analysis upon disclosure during treatment that they concurrently were in psychological treatment elsewhere, bringing down the final number of participants in the study to $n$ = 205. During the course of treatment, one additional participant in the `r xG2` group asked to withdraw (and for which only pre-measurements were used in the analysis).

## Patient flow during the study

```{bash, include=F, eval = F}

filename="flowchart"

cat <<EOF > $filename.dot
digraph G {

  node [ shape=box ]
  compound=true
  ranksep=.275
  
  leads -> { screening_non_completers screening_completers }
  screening_completers -> { excluded invited }
  invited  -> { invitation_non_responders invitation_responders }
  invitation_responders -> { trimmed keepers }
  keepers -> randomization
  randomization -> { selfhelp_dur support_dur waitlist_dur }

  leads[label=<Leads from social media<BR/><I>n</I> = 657>]
  screening_completers[label=<Completed screening<BR/><I>n</I> = 464>]
  excluded[label=<Excluded from study<BR/><I>n</I> = 126, for the following reasons:<BR/>PHQ-9 cutoff (≥ 15), <I>n</I> = 77<BR/>Concurrent therapy, <I>n</I> = 29<BR/>Recent change in psychotropic drugs, <I>n</I> = 7<BR/>Low motivation/lack of time, <I>n</I> = 13>]
  screening_non_completers[label=<Did not complete screening<BR/><I>n</I> = 193>]
  invited[label=<Invited to participate in study<BR/><I>n</I> = 338>]
  invitation_non_responders[label=<Declined or did not respond<BR/><I>n</I> = 85>]
  invitation_responders[label=<Accepted invitation<BR/><I>n</I> = 253>]
  trimmed[label=<Excluded by randomization<BR/><I>n</I> = 43>]
  keepers[label=<Included by randomization<BR/><I>n</I> = 210>]
  randomization[label=<Randomization to condition<BR/><I>n</I> = 70 each>]
  selfhelp_dur[label=<Completed 4 week measurement<BR/><I>n</I> = 44>]
  selfhelp_post[label=<Completed post measurement<BR/><I>n</I> = 35>]
  selfhelp_fu[label=<Completed 1 year follow-up<BR/><I>n</I> = 30>]
  support_dur[label=<Completed 4 week measurement<BR/><I>n</I> = 48>]
  support_post[label=<Completed post measurement<BR/><I>n</I> = 50>]
  support_fu[label=<Completed 1 year follow-up<BR/><I>n</I> = 38>]
  waitlist_dur[label=<Completed 4 week measurement<BR/><I>n</I> = 58>]
  waitlist_post[label=<Completed post measurement<BR/><I>n</I> = 61>]
  itt[label=<Intention to treat<BR/><I>n</I> = 205>]

  subgraph cluster_selfhelp { margin=8; labelloc="t"; color=black; bgcolor=white; label=<Selfhelp<BR/><I>n</I> = 70 – 3 (excluded) = 67> ; selfhelp_dur -> selfhelp_post -> selfhelp_fu; } 
  subgraph cluster_support { margin=8; labelloc="t"; color=black; bgcolor=white; label=<Support<BR/><I>n</I> = 70> ; support_dur -> support_post -> support_fu; } 
  subgraph cluster_waitlist { margin=8; labelloc="t"; color=black; bgcolor=white; label=<Waitlist<BR/><I>n</I> = 70 – 2 (excluded) = 68> ; waitlist_dur -> waitlist_post; } 
  { selfhelp_fu support_fu waitlist_post } -> itt

}
EOF

#> sum(r2fu.wide.data$group == "selfhelp" & !is.na(r2fu.wide.data$rathus.4))
#[1] 30
#> sum(r2fu.wide.data$group == "support" & !is.na(r2fu.wide.data$rathus.4))
#[1] 38

/opt/homebrew/bin/dot -Tpdf -o$filename.pdf $filename.dot
/Library/TeX/texbin/pdfcrop $filename.pdf

```

\centering\includegraphics[height=\textheight-1.75cm]{flowchart-crop.pdf}

## Sociodemographic data

```{r def demdata, cache = F, eval = F}

xdemocat <-
  c(
  "M (SD)",
  "Female",
  "Single",
  "Partner",
  "Married",
  "Other",
  "Other education",
  "Primary/lower secondary",
  "Higher secondary",
  "Vocational training ",
  "Current higher education",
  "Finished higher education",
  "Other occupation",
  "Student",
  "Working",
  "Unemployed",
  "Pensioner",
  "Parental leave",
  "On sick leave",
  "No",
  "Yes, previously",
  "Yes, currently",
  "No",
  "Yes"
  )

options(OutDec= ",")

xdemodata <- rbind(
  prop.table(cbind(
    table(r2fu.wide.data$Demografi.Kon, r2fu.wide.data$group),
    margin.table(table(
      r2fu.wide.data$Demografi.Kon, r2fu.wide.data$group
    ), 1)
  ), 2),
  prop.table(cbind(
    table(r2fu.wide.data$Demografi.Civilstand, r2fu.wide.data$group),
    margin.table(table(
      r2fu.wide.data$Demografi.Civilstand, r2fu.wide.data$group
    ), 1)
  ), 2),
  prop.table(cbind(
    table(r2fu.wide.data$Demografi.Utbildning, r2fu.wide.data$group),
    margin.table(table(
      r2fu.wide.data$Demografi.Utbildning, r2fu.wide.data$group
    ), 1)
  ), 2),
  prop.table(cbind(
    table(r2fu.wide.data$Demografi.Sysselsattning, r2fu.wide.data$group),
    margin.table(table(
      r2fu.wide.data$Demografi.Sysselsattning, r2fu.wide.data$group
    ), 1)
  ), 2),
  prop.table(cbind(
    table(r2fu.wide.data$Demografi.Psykofarmaka, r2fu.wide.data$group),
    margin.table(table(
      r2fu.wide.data$Demografi.Psykofarmaka, r2fu.wide.data$group
    ), 1)
  ), 2),
  prop.table(cbind(
    table(
      r2fu.wide.data$Demografi.PsykoBehandling, r2fu.wide.data$group),
      margin.table(table(
        r2fu.wide.data$Demografi.PsykoBehandling, r2fu.wide.data$group
      ), 1)
  ), 2)
)

xdemodatax <- as.data.frame(t(round(xdemodata[-1,],2) * 100))

xdemodatax$x <- as.factor(c(
    paste(xresultT(mean(r2fu.wide.data[wg3,64]),0)," (",xresultT(sd(r2fu.wide.data[wg3,64]),0),")",sep=""),
    paste(xresultT(mean(r2fu.wide.data[wg1,64]),0)," (",xresultT(sd(r2fu.wide.data[wg1,64]),0),")",sep=""),
    paste(xresultT(mean(r2fu.wide.data[wg2,64]),0)," (",xresultT(sd(r2fu.wide.data[wg2,64]),0),")",sep=""),
    paste(xresultT(mean(r2fu.wide.data[,64]),0)," (",xresultT(sd(r2fu.wide.data[,64]),0),")",sep="")
  ))

xdemodatax <- xdemodatax[,c(24,1:23)]

colnames(xdemodatax) <- xdemocat

demdata.tabell <- t(xdemodatax)

colnames(demdata.tabell) <- c(
  paste(xG3," (n = ",ll3,")",sep=""),
  paste(xG1," (n = ",ll1,")",sep=""),
  paste(xG2," (n = ",ll2,")",sep=""),
  paste("Total (n = ",length(r2fu.wide.data[,1]),")",sep="")
)

options(OutDec= ".")

```

```{r demdata, out.width="100%", tab.align="center", cache = F, escape=F, eval = F}

library("kableExtra")
# http://haozhu233.github.io/kableExtra/best_practice_for_newline_in_latex_table.pdf

knitr::kable(demdata.tabell, format="latex", booktabs=T, caption = "(ref:dem)", align="ccc") %>%
  kable_styling(full_width = F) %>%
  column_spec(1, width = "12em") %>%
  column_spec(2, width = "4em") %>%
  column_spec(3, width = "4em") %>%
  column_spec(4, width = "6.3em") %>%
  column_spec(5, width = "5em") %>%
  pack_rows("Age (years)", 1, 1, bold = F) %>%
  pack_rows("Sex (%)", 2, 2, bold = F) %>%
  pack_rows("Marital status (%)", 3, 6, bold = F) %>%
  pack_rows("Education (%)", 7, 12, bold = F) %>%
  pack_rows("Occupation (%)", 13, 19, bold = F) %>%
  pack_rows("Use of psychotropic drugs (%)", 20, 22, bold = F) %>%
  pack_rows("Previous therapy experience (%)", 23, 24, bold = F) %>%
  row_spec(c(1,2,6,12,19,22), extra_latex_after = "\\midrule")

```

2do: table

## Measures

### Primary questions

The primary questions were investigated using Adaptive and Aggressive Assertiveness Scales, allowing for discrimination between adaptive assertiveness and aggressive assertiveness [@Thompson2011].

### Secondary questions

The secondary questions were assessed using Rathus [@Thompson2011] for a composite measure of assertiveness, PHQ-9 [@Kroenke2001a] for depression, GAD-7 [@Kroenke2006] for generalized anxiety, LSAS-24 [@Fresco2001] for social phobia and Välmåendeskalan for general well-being.

## Respect^2^ intervention

The contents of the intervention is described in detail in @Hagberg1434243. The intervention was delivered using the proven iTerapi internet platform [@Vlaescu2016], allowing for secure connections, two-factor authentication, content distribution, on-line exercises and quizzes, administration of scales/measures, medical record keeping, and built-in messaging between participants and therapists. All communications between participants and therapists were kept secure using SHA-256 cryptography.

## Ethical considerations I

The study was approved by Swedish Ethical Review Authority (Etikprövningsmyndigheten) with diary number 2019-05165 and was pre-registred at https://clinicaltrials.gov/ct2/show/NCT04240249. 

To improve reproducibility, only open-source and freely licensed tools were used in the analysis of data. Source code and anonymized data are published at https://github.com/hmep/respektikvadrat (original master thesis study) and https://github.com/hmep/r2fu respectively (present study, which also includes follow-up measurements). The final versions are deposited at https://doi.org/10.17045/sthlmuni.12148785 [@R2data2020] and (new figshare repository) respectively.

## Ethical considerations II

Participants were subjected to possible risks, including:

- Increased levels of anxiety in the short term
  - This is expected; by design behavioral experiments allow inhibitory learning (habituation and/or increased tolerance) that alleviates anxiety in the long run
- Increased levels of interpersonal problems
  - This can be problematic if a person cannot control the effects of participation on their interpersonal environment; however we tried to mitigate this issue by excluding persons at higher risk for depression, by offering clear guidelines for terminating participation, as well as referring severely ill participants to external care givers where appropriate

## Statistical software

Analyses were performed using `r R.Version()$language` version `r paste(R.Version()[c("major", "minor")], collapse = ".")` with packages `r paste("@R-",packages,sep="")` through the @rstudio integrated development environment (IDE).

## Mixed model analysis

Primary analyses were performed employing a *mixed-effects model*, sometimes called *multilevel model* or *hierarchical linear model*, in order to gain insights into random effects (in this case, observed but unrestrained effects within individuals) as well as fixed effects (controlled through study design). Mixed-effects models thus maximize use of info in the data. They also handle missing data gracefully by means of predicting outcomes for all combinations of subjects and time-points, respecting the intention-to-treat assignments. 

## Estimation of effect sizes

*Estimated marginal means* or *least square means* were calculated for all combinations of condition assignment and measurement time point. Additionally, pairwise comparisons across these were performed, and effect sizes between assignments and time points were estimated.

## Analyses of reliable change and clinical significance

To assess clinically relevant changes, analyses of reliable change and clinical significance [@Jacobson1991] were performed using raw (not predicted) data. To check if the number of clinically relevant changes were significantly different between assignments, a Kruskal-Wallis $\chi^2$-test was employed.

## Additional checks

Internal reliability of translated measures was estimated using Cronbach's $\alpha$ calculations.

<!-- Check original alpha values in literature! -->

# Results

```{r checks, eval = F, include = F}

rathus.alpha <- performance::cronbachs_alpha(r2.item.data[,1:30])

#Adaptive = #1 + #2 + #5 + #7 + #9 + #10 + #13 + #15 + #17 + #19 + #21 + #22 + #24 + #26 + #28
#Aggressive = #3 + #4 + #6 + #8 + #11 + #12 + #14 + #16 + #18 + #20 + #23 + #25 + #27 + #29 + #30
ad_selection <- c(1,2,5,7,9,10,13,15,17,19,21,22,24,26,28) + 30
ag_selection <- c(3,4,6,8,11,12,14,16,18,20,23,25,27,29,30) + 30
aaas_ad.alpha <- performance::cronbachs_alpha(r2.item.data[,ad_selection])
aaas_ag.alpha <- performance::cronbachs_alpha(r2.item.data[,ag_selection])

lsas.alpha <- performance::cronbachs_alpha(r2.item.data[,61:108])

gad.alpha <- performance::cronbachs_alpha(r2.item.data[,109:115])

phq.alpha <- performance::cronbachs_alpha(r2.item.data[,116:124])

well.alpha <- performance::cronbachs_alpha(r2.item.data[,126:143])

```

## Pre checks

- All groups were balanced at baseline
- All newly translated scales were found to be sufficiently reliable internally
- There was no differential dropout rate between groups (2do: double-check if still holds for fu timepoint)

```{r modelselection}

```

```{r mixedmodels, results="asis", fig.width = 13, fig.asp = 0.75}

### Primary measures

# library(brms)
# 
# # https://www.youtube.com/channel/UCNJK6_DZvcMqNSzQdEkzvzA
# # https://bayesat.github.io/lund2018/slides/andrey_anikin_slides.pdf
# # https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
# xformula = aaas_ad ~ group * time + (1 + time | subject)
# xdata = r2fu.long.data[,]
# scode <- make_stancode(xformula, data = xdata)
# sdata <- make_standata(xformula, data = xdata)
# stanfit <- rstan::stan(model_code = scode, data = sdata, control = list(adapt_delta = 0.99))
# fit8 <- brm(xformula, data = xdata, empty = TRUE)
# fit8$fit <- stanfit
# fit8 <- rename_pars(fit8)
# summary(fit8)
# fit8.plot <- plot(ggemmeans(fit8, terms = c("time", "group")))
# 
# aaas_ad.emm.by.group <- emmeans(fit8, ~ time | group, adjust="bonferroni")
# aaas_ad.emm.by.time <- emmeans(aaas_ad.lmer, ~ group | time, adjust="bonferroni")
# aaas_ad.emmpairs.by.group <- tidy(pairs(emmeans(aaas_ad.lmer, ~ time | group), adjust="bonferroni"))
# aaas_ad.emmpairs.by.time <- tidy(pairs(emmeans(aaas_ad.lmer, ~ group | time), adjust="bonferroni"))
# 
# tidy(aaas_ad.emm.by.group)[4,c(3:5)]
# tidy(pairs(aaas_ad.emm.by.group[-c(4,8,12),], adjust="bonferroni"))
# 
# 
# fit8.eff.by.group <- eff_size(aaas_ad.emm.by.group[-4], sigma = 7, edf = df.residual(fit8))
# 
# aaas_ad.brm <-
#   brms::brm(
#     aaas_ad ~ group * time + (1 + time | subject),
#     data = r2fu.long.data[lnt4,],
#     chains = 4, cores = 8, future = T, iter = 4000
#   )
# summary(aaas_ad.brm)
# plot(aaas_ad.brm)
# pp_check(aaas_ad.brm)
# aaas_ag.emm.plot2 <- plot(ggemmeans(aaas_ad.brm, terms = c("time", "group")))
# 
# aaas_ad.brmx <-
#   brms::brm(
#     aaas_ad ~ group * time + (1 + time | subject),
#     data = r2fu.long.data,
#     chains = 4, cores = 8
#   )
# aaas_ag.emm.plot4 <- plot(ggemmeans(aaas_ad.brmx, terms = c("time", "group")))
# 
# aaas_ad.lmerx <-
#   lme4::lmer(
#     aaas_ad ~ group * time + (1 | subject),
#     data = r2fu.long.data[lnt4,],
#     na.action = na.omit,
#     REML = T
#   )
# aaas_ag.emm.plot3 <- plot(ggemmeans(aaas_ad.lmerx, terms = c("time", "group")))
# 
# modelfit.all <- lme4::allFit(aaas_ad.lmer)
# ss <- summary(modelfit.all)

aaas_ad.lmer <-
  lme4::lmer(
    aaas_ad ~ group * time + (1 | subject),
    data = r2fu.long.data,
    na.action = na.omit,
    REML = T
  )
# performance::check_model(aaas_ad.lmer) # OK!
# performance::model_performance(aaas_ad.lmer)
# jtools::summ(aaas_ad.lmer, confint = T)
# jtools::plot_summs(aaas_ad.lmer)
aaas_ad.emm.plot <- plot(ggemmeans(aaas_ad.lmer, terms = c("time", "group")))

aaas_ag.lmer <-
  lme4::lmer(
    aaas_ag ~ group * time + (1 | subject),
    data = r2fu.long.data,
    na.action = na.omit,
    REML = T
  )
# performance::check_model(aaas_ag.lmer) # OK!
# performance::model_performance(aaas_ag.lmer)
# jtools::summ(aaas_ag.lmer, confint = T)
# jtools::plot_summs(aaas_ag.lmer)
aaas_ag.emm.plot <- plot(ggemmeans(aaas_ag.lmer, terms = c("time", "group")))

rathus.lmer <-
  lme4::lmer(
    rathus ~ group * time + (1 | subject),
    data = r2fu.long.data,
    na.action = na.omit,
    REML = T
  )
# performance::check_model(rathus.lmer) # OK!
# performance::model_performance(rathus.lmer)
# jtools::summ(rathus.lmer, confint = T)
# jtools::plot_summs(rathus.lmer)
rathus.emm.plot <- plot(ggemmeans(rathus.lmer, terms = c("time", "group")))

### Secondary measures

lsas_sum.lmer <-
  lme4::lmer(
    lsas_sum ~ group * time + (1 | subject),
    data = r2fu.long.data,
    na.action = na.omit,
    REML = T
  )
# performance::check_model(lsas_sum.lmer) # OK!
# performance::model_performance(lsas_sum.lmer)
# jtools::summ(lsas_sum.lmer, confint = T)
# jtools::plot_summs(lsas_sum.lmer)
lsas_sum.emm.plot <- plot(ggemmeans(lsas_sum.lmer, terms = c("time", "group")))

phq_sum.lmer <-
  lme4::lmer(
    phq_sum ~ group * time + (1 | subject),
    data = r2fu.long.data,
    na.action = na.omit,
    REML = T
  )
# performance::check_model(phq_sum.lmer) # OK!
# performance::model_performance(phq_sum.lmer)
# jtools::summ(phq_sum.lmer, confint = T)
# jtools::plot_summs(phq_sum.lmer)
phq_sum.emm.plot <- plot(ggemmeans(phq_sum.lmer, terms = c("time", "group")))

gad_sum.lmer <-
  lme4::lmer(
    gad_sum ~ group * time + (1 | subject),
    data = r2fu.long.data,
    na.action = na.omit,
    REML = T
  )
# performance::check_model(gad_sum.lmer) # OK!
# performance::model_performance(gad_sum.lmer)
# jtools::summ(gad_sum.lmer, confint = T)
# jtools::plot_summs(gad_sum.lmer)
gad_sum.emm.plot <- plot(ggemmeans(gad_sum.lmer, terms = c("time", "group")))

well.lmer <-
  lme4::lmer(
    well ~ group * time + (1 | subject),
    data = r2fu.long.data,
    na.action = na.omit,
    REML = T
  )
# performance::check_model(well.lmer) # OK!
# performance::model_performance(well.lmer)
# jtools::summ(well.lmer, confint = T)
# jtools::plot_summs(well.lmer)
well.emm.plot <- plot(ggemmeans(well.lmer, terms = c("time", "group")))

```

```{r exp, eval = F, include = F}

####### EXPERIMENTS

# https://stats.stackexchange.com/questions/35071/what-is-rank-deficiency-and-how-to-deal-with-it
# https://stackoverflow.com/questions/37090722/lme4lmer-reports-fixed-effect-model-matrix-is-rank-deficient-do-i-need-a-fi

well.lmer <-
  lme4::lmer(
    well ~ group * time + (1 | subject),
    data = r2fu.long.data,
    na.action = na.omit,
    REML = T
  )
well.emm.plot <- plot(ggemmeans(well.lmer, terms = c("time", "group")))
well.emm.plot + theme_apa()

well.lmer.lnt4 <-
  lme4::lmer(
    well ~ group * time + (1 | subject),
    data = r2fu.long.data[lnt4,],
    na.action = na.omit,
    REML = T
  )
well.emm.plot <- plot(ggemmeans(well.lmer.lnt4, terms = c("time", "group")))
well.emm.plot + theme_apa()

well.lmer.lng3 <-
  lme4::lmer(
    well ~ group * time + (1 | subject),
    data = r2fu.long.data[lng3,],
    na.action = na.omit,
    REML = T
  )
well.emm.plot <- plot(ggemmeans(well.lmer.lng3, terms = c("time", "group")))
well.emm.plot + theme_apa()

well.lmer.fix <-
  lme4::lmer(
    well ~ group * time + (1 | subject),
    data = r2fu.long.data,
    na.action = na.omit,
    REML = T
  )
well.emm.plot <- plot(ggemmeans(well.lmer.fix, terms = c("time", "group")))
well.emm.plot + theme_apa()

well.lmer.fix <-
  lme4::lmer(
    well ~ group * time + (1 | subject),
    data = r2fu.long.data,
    na.action = na.omit,
    REML = T
  )
well.emm.plot <- plot(ggemmeans(well.lmer.fix, terms = c("time", "group")))
well.emm.plot + theme_apa()

well.lm <-
  lm(
    well ~ group * time ,
    data = r2fu.long.data
  )
well.emm.plot <- plot(ggemmeans(well.lm, terms = c("time", "group")))
well.emm.plot + theme_apa()
interactions::cat_plot(well.lm, pred = "time", modx = "group", geom = "line", plot.points = T, vary.lty = T, line.thickness = .5, point.size = .5, pred.point.size = 4, jitter = .35) + theme_apa()

# fix.formula <- well ~ group * time
# 
# X <- model.matrix (fix.formula, r2fu.long.data)
# caret::findLinearCombos(X)
# 
# fix.fit <- lm(fix.formula, r2fu.long.data, method = "qr", singular.ok = TRUE)
# p <- length(coef)
# coef <- fix.fit$coef
# no.NA <- sum(is.na(coef))
# rank <- fix.fit$rank



# interactions::cat_plot(well.lmer, pred = "time", modx = "group", geom = "line", plot.points = T, vary.lty = T, line.thickness = .5, point.size = .5, pred.point.size = 4, jitter = .35) + theme_apa()

```


```{r predictions}

### Output predictions to new data frame
# https://rdrr.io/cran/modelr/man/add_predictions.html

# Create new data frame with factor variables in place
r2fu.predicted.data <- r2fu.long.data[,c(1:3)]

# Add predicted values to data frame
r2fu.predicted.data <- r2fu.predicted.data %>% spread_predictions(
  rathus.lmer,
  aaas_ag.lmer,
  aaas_ad.lmer,
  lsas_sum.lmer,
  gad_sum.lmer,
  phq_sum.lmer,
  well.lmer
)

# Set column names
colnames(r2fu.predicted.data) <-
  c(
    "subject",
    "group",
    "time",
    "rathus",
    "aaas_ag",
    "aaas_ad",
    "lsas_sum",
    "gad_sum",
    "phq_sum",
    "well"
  )

#lattice::xyplot(well ~ time, r2fu.predicted.data, type = "b")

```


```{r emmeff, eval = T}

effsel <- c(1:3,5:8,9:12)

# AAA-S Adaptive

aaas_ad.emm.by.group <- emmeans(aaas_ad.lmer, ~ time | group, adjust="bonferroni")
aaas_ad.emm.by.time <- emmeans(aaas_ad.lmer, ~ group | time, adjust="bonferroni")
aaas_ad.emmpairs.by.group <- tidy(pairs(emmeans(aaas_ad.lmer, ~ time | group), adjust="bonferroni"))
aaas_ad.emmpairs.by.time <- tidy(pairs(emmeans(aaas_ad.lmer, ~ group | time), adjust="bonferroni"))

# aaas_ad.sd <- sqrt(6.7247^2 + 4.6582^2) # VarCorr(aaas_ad.lmer)
# aaas_ad.eff.by.group <- tidy(eff_size(aaas_ad.emm.by.group, sigma = aaas_ad.sd, edf = df.residual(aaas_ad.lmer)))
# aaas_ad.eff.by.time <- tidy(eff_size(aaas_ad.emm.by.time, sigma = aaas_ad.sd, edf = df.residual(aaas_ad.lmer)))

# AAA-S Aggressive

aaas_ag.emm.by.group <- emmeans(aaas_ag.lmer, ~ time | group, adjust="bonferroni")
aaas_ag.emm.by.time <- emmeans(aaas_ag.lmer, ~ group | time, adjust="bonferroni")
aaas_ag.emmpairs.by.group <- tidy(pairs(emmeans(aaas_ag.lmer, ~ time | group), adjust="bonferroni"))
aaas_ag.emmpairs.by.time <- tidy(pairs(emmeans(aaas_ag.lmer, ~ group | time), adjust="bonferroni"))

# aaas_ag.sd <- sqrt(5.6919^2 + 3.3895^2) # VarCorr(aaas_ag.lmer)
# aaas_ag.eff.by.group <- tidy(eff_size(aaas_ag.emm.by.group, sigma = aaas_ag.sd, edf = df.residual(aaas_ag.lmer)))
# aaas_ag.eff.by.time <- tidy(eff_size(aaas_ag.emm.by.time, sigma = aaas_ag.sd, edf = df.residual(aaas_ag.lmer)))

# Rathus

rathus.emm.by.group <- emmeans(rathus.lmer, ~ time | group, adjust="bonferroni")
rathus.emm.by.time <- emmeans(rathus.lmer, ~ group | time, adjust="bonferroni")
rathus.emmpairs.by.group <- tidy(pairs(emmeans(rathus.lmer, ~ time | group), adjust="bonferroni"))
rathus.emmpairs.by.time <- tidy(pairs(emmeans(rathus.lmer, ~ group | time), adjust="bonferroni"))

# rathus.sd <- sqrt(19.908^2 + 11.678^2) # VarCorr(rathus.lmer)
# rathus.eff.by.group <- tidy(eff_size(rathus.emm.by.group, sigma = rathus.sd, edf = df.residual(rathus.lmer)))

# LSAS-SR

lsas_sum.emm.by.group <- emmeans(lsas_sum.lmer, ~ time | group, adjust="bonferroni")
lsas_sum.emmpairs.by.group <- tidy(pairs(emmeans(lsas_sum.lmer, ~ time | group), adjust="bonferroni"))

# lsas_sum.sd <- sqrt(19.1059^2 + 8.7701^2) # VarCorr(lsas_sum.lmer)
# lsas_sum.eff.by.group <- tidy(eff_size(lsas_sum.emm.by.group, sigma = lsas_sum.sd, edf = df.residual(lsas_sum.lmer)))

# GAD-7

gad_sum.emm.by.group <- emmeans(gad_sum.lmer, ~ time | group, adjust="bonferroni")
gad_sum.emmpairs.by.group <- tidy(pairs(emmeans(gad_sum.lmer, ~ time | group), adjust="bonferroni"))

# gad_sum.sd <- sqrt(3.1746^2 + 2.72911^2) # VarCorr(gad_sum.lmer)
# gad_sum.eff.by.group <- tidy(eff_size(gad_sum.emm.by.group, sigma = gad_sum.sd, edf = df.residual(gad_sum.lmer)))

# PHQ-9

phq_sum.emm.by.group <- emmeans(phq_sum.lmer, ~ time | group, adjust="bonferroni")
phq_sum.emmpairs.by.group <- tidy(pairs(emmeans(phq_sum.lmer, ~ time | group), adjust="bonferroni"))

# phq_sum.rg <- ref_grid(phq_sum.lmer)
# summary(phq_sum.rg[c(1:9,11:12)])
# phq_sum.sav <- as.list(phq_sum.rg[c(1:9,11:12)])
# phq_sum.anew <- as.emmGrid(phq_sum.sav)
# emmeans(phq_sum.anew)

# pigs.lm <- lm(log(conc) ~ source + factor(percent), data = pigs)
# pigs.sav <- as.list(ref_grid(pigs.lm))
# pigs.anew <- as.emmGrid(pigs.sav)
# emmeans(pigs.anew, "source")

phq_sum.sd <- sqrt(2.9778^2 + 3.0234^2) # VarCorr(phq_sum.lmer)
############### FIXAT! ############
phq_sum.eff.by.group <- eff_size(phq_sum.emm.by.group[effsel], sigma = phq_sum.sd, edf = df.residual(phq_sum.lmer))
# phq_sum.eff.by.group <- tidy(eff_size(phq_sum.emm.by.group, sigma = phq_sum.sd, edf = df.residual(phq_sum.lmer)))



# Välmåendeskalan

well.emm.by.group <- emmeans(well.lmer, ~ time | group, adjust="bonferroni")
well.emmpairs.by.group <- tidy(pairs(emmeans(well.lmer, ~ time | group), adjust="bonferroni"))

# well.sd <- sqrt(8.6002^2 + 7.2944^2) # VarCorr(well.lmer)
# well.eff.by.group <- tidy(eff_size(well.emm.by.group, sigma = well.sd, edf = df.residual(well.lmer)))

options(OutDec= ",")

```

## Primary questions

TBW

## Adaptive assertiveness plot

```{r aaas_ad.emm.plot}

aaas_ad.emm.plot <- plot(ggemmeans(aaas_ad.lmer, terms = c("time", "group")))
aaas_ad.emm.plot + theme_apa()

```

## Aggressive assertiveness plot

```{r aaas_ag.emm.plot}

aaas_ag.emm.plot <- plot(ggemmeans(aaas_ag.lmer, terms = c("time", "group")))
aaas_ag.emm.plot + theme_apa()

```

## Rathus plot

```{r rathus.emm.plot}

rathus.emm.plot <- plot(ggemmeans(rathus.lmer, terms = c("time", "group")))
rathus.emm.plot + theme_apa()

```

<!-- ## Rathus plot (interactions) -->

<!-- ```{r rathus.interactions.plot} -->

<!-- # https://interactions.jacob-long.com/reference/cat_plot.html -->

<!-- cat_plot(rathus.lmer, data = r2fu.long.data, pred = "time", modx = "group", geom = "line", plot.points = T, vary.lty = T, int.type = "confidence", line.thickness = 0.5, point.size = 1, pred.point.size = 4, jitter = 0.25) + theme_apa() -->

<!-- ``` -->

## Secondary questions

TBW

## Discussion

Topics from Background section to discuss:

- Assertiveness training
- Internet-delivered vs. in-person CBT
- Self-help vs. therapist support
- Transdiagnostic vs. specialized treatments

## References {.allowframebreaks}

```{r references, include=FALSE}

knitr::write_bib(packages, "packages.bib")

```

<!-- https://stackoverflow.com/questions/35677857/references-truncated-in-beamer-presentation-prepared-in-knitr-rmarkdown/35681531 -->

\small